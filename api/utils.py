import pandas as pd
import re
import io

# --- МЭППИНГ КОЛОНОК ---
COLUMN_MAPPING = {
    "ID": "ID", "Время создания": "Время", "Наименование вашей образовательной организации": "Организация",
    "Код ребёнка": "Код", "Возрастная группа, к которой относится ребенок в текущем учебном году": "Возраст",
    'Субтест И1-1 "Рассуждения". Укажите суммарную оценку': "И1-1Сум",
    'Субтест И1-2 "Рассуждения". Укажите значение по каждому критерию / Связность': "И1-2Связн",
    'Субтест И1-2 "Рассуждения". Укажите значение по каждому критерию / Речевое оформление высказываний': "И1-2РечОформ",
    'Субтест И1-2 "Рассуждения". Укажите значение по каждому критерию / Самостоятельность рассуждения': "И1-2СамРасс",
    'Субтест И2 "Сходство". Укажите суммарную оценку.': "И2Сум",
    'Субтест И3-1-1 "Будь внимателен". Введите количество колец, просмотренных за 1-ю минуту (целое число)': "И3-1Кольца",
    'Субтест И3-1-2 "Будь внимателен". Введите количество ошибок, допущенных за 1-ю минуту (целое число)': "И3-1Ошиб",
    'Субтест И3-2-1 "Будь внимателен". Введите количество колец, просмотренных за 2-ю минуту (целое число)': "И3-2Кольца",
    'Субтест И3-2-2 "Будь внимателен". Введите количество ошибок, допущенных за 2-ю минуту (целое число)': "И3-2Ошиб",
    'Субтест И3-3-1 "Будь внимателен". Введите количество колец, просмотренных за 3-ю минуту (целое число)': "И3-3Кольца",
    'Субтест И3-3-2 "Будь внимателен". Введите количество ошибок, допущенных за 3-ю минуту (целое число)': "И3-3Ошиб",
    'Субтест И3-4-1 "Будь внимателен". Введите количество колец, просмотренных за 4-ю минуту (целое число)': "И3-4Кольца",
    'Субтест И3-4-2 "Будь внимателен". Введите количество ошибок, допущенных за 4-ю минуту (целое число)': "И3-4Ошиб",
    'Субтест И3-5-1 "Будь внимателен". Введите количество колец, просмотренных за 5-ю минуту (целое число)': "И3-5Кольца",
    'Субтест И3-5-2 "Будь внимателен". Введите количество ошибок, допущенных за 5-ю минуту (целое число)': "И3-5Ошиб",
    'Субтест И4 "Недостающие детали". Введите число верных ответов': "И4Сум",
    'Субтест И5-1-1 "Лабиринты": укажите время прохождения лабиринта 1 (в секундах)': "И5-1Время",
    'Субтест И5-1-2 "Лабиринты": укажите количество ошибок при прохождении лабиринта 1 (целое число)': "И5-1Ошиб",
    'Субтест И5-1-3 "Лабиринты". Отметьте, дошел ли ребенок до цели в указанное Вами время в лабиринте 1': "И5-1Дошел",
    'Субтест И5-2-1 "Лабиринты": укажите время прохождения лабиринта 2 (в секундах)': "И5-2Время",
    'Субтест И5-2-2 "Лабиринты": укажите количество ошибок при прохождении лабиринта 2 (целое число)': "И5-2Ошиб",
    'Субтест И5-2-3 "Лабиринты". Отметьте, дошел ли ребенок до цели в указанное Вами время в лабиринте 2': "И5-2Дошел",
    'Субтест И5-3-1 "Лабиринты": укажите время прохождения лабиринта 3 (в секундах)': "И5-3Время",
    'Субтест И5-3-2 "Лабиринты": укажите количество ошибок при прохождении лабиринта 3 (целое число)': "И5-3Ошиб",
    'Субтест И5-3-3 "Лабиринты". Отметьте, дошел ли ребенок до цели в указанное Вами время в лабиринте 3': "И5-3Дошел",
    'Субтест И5-4-1 "Лабиринты": укажите время прохождения лабиринта 4 (в секундах)': "И5-4Время",
    'Субтест И5-4-2 "Лабиринты": укажите количество ошибок при прохождении лабиринта 4 (целое число)': "И5-4Ошиб",
    'Субтест И5-4-3 "Лабиринты". Отметьте, дошел ли ребенок до цели в указанное Вами время в лабиринте 4': "И5-4Дошел",
    'Субтест И5-5-1 "Лабиринты": укажите время прохождения лабиринта 5 (в секундах)': "И5-5Время",
    'Субтест И5-5-2 "Лабиринты": укажите количество ошибок при прохождении лабиринта 5 (целое число)': "И5-5Ошиб",
    'Субтест И5-5-3 "Лабиринты". Отметьте, дошел ли ребенок до цели в указанное Вами время в лабиринте 5': "И5-5Дошел",
    'Адаптированная проба "Художник". \nВведите значения по шкалам В1 и В2. / В1': "В1",
    'Адаптированная проба "Художник". \nВведите значения по шкалам В1 и В2. / В2': "В2",
    'Методика идентификации базовых эмоций. / Укажите итоговую оценку': "ЭмоцИдент",
    'Методика наблюдения за совместной деятельностью. Укажите средние значения результатов экспертного наблюдения по видам деятельности / Планирование': "Планир",
    'Методика наблюдения за совместной деятельностью. Укажите средние значения результатов экспертного наблюдения по видам деятельности / Сотрудничество и сотворчество': "Сотруд",
    'Методика наблюдения за совместной деятельностью. Укажите средние значения результатов экспертного наблюдения по видам деятельности / Рефлексия': "Рефлек"
}

# --- НОРМЫ ПО ВОЗРАСТАМ ---
# Ключ: возраст (начало интервала). Например, 3 -> "3-4 года"
AGE_NORMS = {
    2: {'low': 0.25, 'high': 0.55}, # 2-3 года (Сниженная планка)
    3: {'low': 0.30, 'high': 0.60}, # 3-4 года
    4: {'low': 0.35, 'high': 0.65}, # 4-5 лет
    5: {'low': 0.40, 'high': 0.70}, # 5-6 лет
    6: {'low': 0.45, 'high': 0.75}, # 6-7 лет
    7: {'low': 0.50, 'high': 0.80}, # 7+ лет
}
DEFAULT_NORM = {'low': 0.33, 'high': 0.66} # Если возраст не указан

def get_age_from_string(age_str):
    """
    Пытается найти возраст в строке.
    Примеры: "5-6 лет" -> 5, "2-3 года" -> 2, "6-7 (подготовительная)" -> 6
    """
    try:
        # Ищем первую цифру в строке
        match = re.search(r'(\d+)', str(age_str))
        if match:
            return int(match.group(1))
    except:
        pass
    return 0 

def to_float(val):
    if pd.isna(val) or val == "": return 0
    if isinstance(val, (int, float)): return val
    try: return float(str(val).replace(',', '.').replace(' ', '').strip())
    except: return 0

def to_int(val):
    try: return int(to_float(val))
    except: return 0

def calc_lab(time, errors, reached, limit):
    time = to_float(time)
    errors = to_int(errors)
    if isinstance(reached, str) and reached.strip().lower() == "нет": return 0
    if time > limit: return 0
    if errors == 0: return 3
    if errors == 1: return 2
    if 2 <= errors <= 5: return 1
    return 0

def attention_index(rings, errors):
    return 0.5 * to_float(rings) - (2.8 * to_float(errors)) / 60

def categorize_by_age(value, age_str):
    """
    Определяет уровень с учетом возраста ребенка.
    Если возраст не распознан, используется дефолтная норма.
    """
    if pd.isna(value): return "ниже нормативного"
    
    age = get_age_from_string(age_str)
    
    # Получаем пороговые значения (если возраст < 2 или > 7, берем ближайшие или дефолт)
    # Здесь простая логика: ищем точное совпадение ключа
    thresholds = AGE_NORMS.get(age, DEFAULT_NORM)
    
    # Если возраст больше 7, применяем самую строгую норму (как для 7)
    if age > 7:
        thresholds = AGE_NORMS[7]
    
    if value < thresholds['low']:
        return "ниже нормативного"
    elif value <= thresholds['high']:
        return "нормативный"
    else:
        return "выше нормативного"

def process_dataframe(file_storage):
    """
    Основная функция обработки. Читает файл, чистит данные, считает баллы
    и проставляет уровни с учетом возраста.
    """
    file_content = file_storage.read()
    file_io = io.BytesIO(file_content)
    
    try:
        df = pd.read_excel(file_io, sheet_name=0)
    except:
        file_io.seek(0)
        try:
            df = pd.read_csv(file_io, sep=None, engine='python')
        except Exception as e:
            raise ValueError(f"Ошибка формата файла: {e}")

    df.columns = df.columns.str.strip()
    df = df.rename(columns=COLUMN_MAPPING)

    # Заполнение пропусков нулями для расчетных колонок
    for col in COLUMN_MAPPING.values():
        if col not in df.columns: df[col] = 0

    # Очистка числовых данных
    numeric_cols = [c for c in df.columns if c not in ["ID", "Организация", "Код", "Возраст"]]
    for col in numeric_cols:
        df[col] = df[col].apply(to_float)

    # --- РАСЧЕТ МЕТРИК ---
    df["П1"] = df.apply(lambda x: calc_lab(x.get("И5-1Время"), x.get("И5-1Ошиб"), x.get("И5-1Дошел"), 35), axis=1)
    df["П2"] = df.apply(lambda x: calc_lab(x.get("И5-2Время"), x.get("И5-2Ошиб"), x.get("И5-2Дошел"), 35), axis=1)
    df["П3"] = df.apply(lambda x: calc_lab(x.get("И5-3Время"), x.get("И5-3Ошиб"), x.get("И5-3Дошел"), 50), axis=1)
    df["П4"] = df.apply(lambda x: calc_lab(x.get("И5-4Время"), x.get("И5-4Ошиб"), x.get("И5-4Дошел"), 65), axis=1)
    df["П5"] = df.apply(lambda x: calc_lab(x.get("И5-5Время"), x.get("И5-5Ошиб"), x.get("И5-5Дошел"), 125), axis=1)
    df["Аналит-Синт"] = ((df[["П1", "П2", "П3", "П4", "П5"]].mean(axis=1)) / 3).round(2)

    for i in range(1, 6):
        df[f"Вним{i}"] = df.apply(lambda x: attention_index(x.get(f"И3-{i}Кольца"), x.get(f"И3-{i}Ошиб")), axis=1)
    df["СредВним"] = df[[f"Вним{i}" for i in range(1, 6)]].mean(axis=1)
    df["Качество внимания"] = df["СредВним"].apply(lambda v: 1 if v >= 6 else round(v / 6, 2))

    df["Связн"] = (df["И1-2Связн"] / 5).round(2)
    df["РечОформ"] = (df["И1-2РечОформ"] / 5).round(2)
    df["СамостРасс"] = (df["И1-2СамРасс"] / 5).round(2)
    df["Готовн_УД"] = ((df["И1-1Сум"] / 18 + (df["Связн"] + df["РечОформ"] + df["СамостРасс"]) / 3) / 2).round(2)
    
    df["Лог_обобщение"] = (df["И2Сум"] / 16).round(2)
    df["Перцепция"] = (df["И4Сум"] / 11).round(2)
    df["Активн_вниман"] = df["Качество внимания"]
    df["Аналит_синт"] = df["Аналит-Синт"]
    df["Воображение"] = (((df["В1"] / 3) + (df["В2"] / 3)) / 2).round(2)
    df["Идентиф_эмоций"] = (df["ЭмоцИдент"] / 8).round(2)
    df["Планирование"] = (df["Планир"] / 4).round(2)
    df["Сотрудничество"] = (df["Сотруд"] / 4).round(2)
    df["Рефлексия"] = (df["Рефлек"] / 4).round(2)

    df["Когнитивное развитие"] = ((df["Готовн_УД"] + df["Активн_вниман"] + df["Аналит_синт"] + df["Лог_обобщение"] + df["Перцепция"]) / 5).round(2)
    df["Воображение_итог"] = df["Воображение"]
    df["ЭмСоцИнтеллект"] = ((df["Идентиф_эмоций"] + (df["Планирование"] + df["Сотрудничество"] + df["Рефлексия"]) / 3) / 2).round(2)

    # --- ПРИМЕНЕНИЕ НОВЫХ НОРМ С УЧЕТОМ ВОЗРАСТА ---
    # Мы передаем в функцию categorize_by_age не только значение, но и строку возраста из этой же строки
    for col in ["Когнитивное развитие", "Воображение_итог", "ЭмСоцИнтеллект"]:
        df[col + "_уровень"] = df.apply(lambda row: categorize_by_age(row[col], row["Возраст"]), axis=1)

    return df
